(function() {
  var Configuration, fs, path, spawn;
  path = require("path");
  fs = require("fs");
  spawn = require("child_process").spawn;
  Configuration = require("./puppy").Configuration;
  module.exports.command = function(argv) {
    var _ref, configuration, email, public, server, ssh, sshKey;
    configuration = new Configuration();
    server = configuration.get("server") || "portoroz.prettyrobots.com";
    public = __dirname + "/../etc/public.pub";
    if (argv.length !== 2) {
      process.exit(1);
    }
    _ref = argv;
    email = _ref[0];
    sshKey = _ref[1];
    sshKey = fs.readFileSync(sshKey, "utf8");
    sshKey = sshKey.substring(0, sshKey.length - 1);
    ssh = spawn("ssh", ["-T", "-i", public, "-l", "public", server]);
    ssh.stdin.end(JSON.stringify(["/puppy/bin/account_register", email, sshKey]));
    ssh.stdout.on("data", function(chunk) {
      return process.stdout.write(chunk.toString());
    });
    ssh.stderr.on("data", function(chunk) {
      return process.stdout.write(chunk.toString());
    });
    return ssh.on("exit", function(code) {
      configuration.setGlobal({
        email: email
      });
      configuration.save();
      return process.exit(code);
    });
  };
}).call(this);
